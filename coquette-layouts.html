<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <title>Coquette Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@500;600&family=Satisfy&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg: #000;
      --surface: #0a0a0a;
      --surface-2: #151515;
      --border: rgba(255,255,255,0.1);
      --text: #fff;
      --text-2: rgba(255,255,255,0.7);
      --text-3: rgba(255,255,255,0.4);
      --accent: #f4a0b0;
    }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--bg); color: var(--text); }
    .app { display: flex; flex-direction: column; height: 100dvh; position: relative; }

    /* Header */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top));
      background: var(--bg); border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .header h1 { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 600; }
    .header-btn {
      width: 42px; height: 42px; border-radius: 50%;
      background: var(--surface-2); border: none; color: var(--text);
      font-size: 18px; cursor: pointer; transition: background 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .header-btn:active { background: var(--surface); }

    /* Preview */
    .preview-area {
      flex: 1; display: flex; align-items: center; justify-content: center;
      padding: 16px; padding-bottom: 80px; overflow: auto; background: #050505;
      min-height: 0; /* Allow shrinking */
      position: relative;
    }
    .bottom-panel.collapsed ~ .preview-area,
    .app:has(.bottom-panel.collapsed) .preview-area {
      padding-bottom: 80px;
    }

    /* Virtual background canvas */
    .vbg-canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }
    .photo-slot video.has-vbg { opacity: 0; }
    .photo-slot .vbg-canvas { border-radius: 3px; }

    /* Frame */
    .photo-frame {
      box-shadow: 0 10px 50px rgba(0,0,0,0.8);
      position: relative; background: #111; padding: 10px; border-radius: 4px;
    }
    .photo-grid { display: grid; gap: 4px; }
    .photo-slot {
      position: relative; overflow: hidden;
      background: rgba(255,255,255,0.1); border-radius: 3px; min-height: 30px;
    }
    .photo-slot img, .photo-slot video {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
    }
    .photo-slot video { transform: scaleX(-1); }
    .photo-slot .placeholder {
      position: absolute; inset: 0; display: flex;
      align-items: center; justify-content: center; font-size: 18px; opacity: 0.3;
    }
    .photo-slot .live-badge {
      position: absolute; top: 4px; left: 4px; background: #ef4444;
      color: white; font-size: 7px; font-weight: 700; padding: 2px 4px;
      border-radius: 3px; text-transform: uppercase;
    }
    .photo-slot .remove-btn {
      position: absolute; top: 3px; right: 3px; width: 18px; height: 18px;
      border-radius: 50%; background: rgba(0,0,0,0.7); border: none;
      color: #fff; font-size: 9px; cursor: pointer; display: none;
      align-items: center; justify-content: center;
    }
    .photo-slot:hover .remove-btn { display: flex; }

    .countdown-overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center;
      font-family: 'Playfair Display', serif; font-size: 40px; font-weight: 600;
      color: white; text-shadow: 0 0 20px rgba(255,255,255,0.5); z-index: 10;
    }
    .countdown-overlay.active { display: flex; }
    .flash-overlay {
      position: absolute; inset: 0; background: white;
      opacity: 0; pointer-events: none; z-index: 20;
    }
    .flash-overlay.active { animation: flash 0.15s; }
    @keyframes flash { 0% { opacity: 1; } 100% { opacity: 0; } }

    .frame-footer {
      margin-top: 10px; text-align: center; font-size: 10px;
      color: rgba(255,255,255,0.5); letter-spacing: 1.5px;
      font-weight: 500;
    }

    /* Tap-to-edit text elements */
    .editable-text {
      cursor: text;
      border: 1px dashed transparent;
      padding: 2px 4px;
      margin: -2px -4px;
      border-radius: 3px;
      transition: border-color 0.2s, background 0.2s;
      min-width: 20px;
      display: inline-block;
    }
    .editable-text:hover {
      border-color: rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.05);
    }
    .editable-text:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.1);
    }
    .editable-text:empty::before {
      content: attr(data-placeholder);
      opacity: 0.4;
    }

    /* ==================== LAYOUTS ==================== */
    /* Responsive frame sizing */
    .photo-frame { --frame-w: min(70vw, 280px); }

    /* Strip 2x6 */
    .layout-strip3 { width: calc(var(--frame-w) * 0.5); }
    .layout-strip3 .photo-grid { grid-template-columns: 1fr; grid-template-rows: repeat(3, calc(var(--frame-w) * 0.35)); }

    .layout-strip4 { width: calc(var(--frame-w) * 0.5); }
    .layout-strip4 .photo-grid { grid-template-columns: 1fr; grid-template-rows: repeat(4, calc(var(--frame-w) * 0.26)); }

    /* 4x6 Grids */
    .layout-grid2x2 { width: var(--frame-w); }
    .layout-grid2x2 .photo-grid { grid-template-columns: 1fr 1fr; grid-template-rows: calc(var(--frame-w) * 0.5) calc(var(--frame-w) * 0.5); }

    .layout-grid3x2 { width: var(--frame-w); }
    .layout-grid3x2 .photo-grid { grid-template-columns: repeat(3, 1fr); grid-template-rows: calc(var(--frame-w) * 0.4) calc(var(--frame-w) * 0.4); }

    /* 4x6 - 3 poses */
    .layout-top1-bot2 { width: var(--frame-w); }
    .layout-top1-bot2 .photo-grid { grid-template-columns: 1fr 1fr; grid-template-rows: calc(var(--frame-w) * 0.5) calc(var(--frame-w) * 0.3); }
    .layout-top1-bot2 .photo-slot:first-child { grid-column: span 2; }

    .layout-top2-bot1 { width: var(--frame-w); }
    .layout-top2-bot1 .photo-grid { grid-template-columns: 1fr 1fr; grid-template-rows: calc(var(--frame-w) * 0.3) calc(var(--frame-w) * 0.5); }
    .layout-top2-bot1 .photo-slot:last-child { grid-column: span 2; }

    /* 4x6 - 4 poses L/R */
    .layout-left1-right3 { width: var(--frame-w); }
    .layout-left1-right3 .photo-grid { grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, calc(var(--frame-w) * 0.27)); }
    .layout-left1-right3 .photo-slot:first-child { grid-row: span 3; }

    .layout-left3-right1 { width: var(--frame-w); }
    .layout-left3-right1 .photo-grid { grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, calc(var(--frame-w) * 0.27)); }
    .layout-left3-right1 .photo-slot:nth-child(4) { grid-row: 1 / span 3; grid-column: 2; }

    /* 4x6 - 2 poses */
    .layout-h2 { width: var(--frame-w); }
    .layout-h2 .photo-grid { grid-template-columns: 1fr; grid-template-rows: calc(var(--frame-w) * 0.4) calc(var(--frame-w) * 0.4); }

    .layout-v2 { width: var(--frame-w); }
    .layout-v2 .photo-grid { grid-template-columns: 1fr 1fr; grid-template-rows: calc(var(--frame-w) * 0.8); }

    .layout-big-small { width: var(--frame-w); }
    .layout-big-small .photo-grid { grid-template-columns: 2fr 1fr; grid-template-rows: calc(var(--frame-w) * 0.8); }

    .layout-small-big { width: var(--frame-w); }
    .layout-small-big .photo-grid { grid-template-columns: 1fr 2fr; grid-template-rows: calc(var(--frame-w) * 0.8); }

    /* 4x6 - 1 pose */
    .layout-single { width: var(--frame-w); }
    .layout-single .photo-grid { grid-template-columns: 1fr; grid-template-rows: calc(var(--frame-w) * 0.8); }

    .layout-portrait { width: calc(var(--frame-w) * 0.6); }
    .layout-portrait .photo-grid { grid-template-columns: 1fr; grid-template-rows: calc(var(--frame-w) * 0.95); }

    /* 4x6 - Mixed */
    .layout-t3-b1 { width: var(--frame-w); }
    .layout-t3-b1 .photo-grid { grid-template-columns: repeat(3, 1fr); grid-template-rows: calc(var(--frame-w) * 0.28) calc(var(--frame-w) * 0.52); }
    .layout-t3-b1 .photo-slot:last-child { grid-column: span 3; }

    .layout-t1-b3 { width: var(--frame-w); }
    .layout-t1-b3 .photo-grid { grid-template-columns: repeat(3, 1fr); grid-template-rows: calc(var(--frame-w) * 0.52) calc(var(--frame-w) * 0.28); }
    .layout-t1-b3 .photo-slot:first-child { grid-column: span 3; }

    .layout-l2-r2 { width: var(--frame-w); }
    .layout-l2-r2 .photo-grid { grid-template-columns: 1fr 1fr; grid-template-rows: calc(var(--frame-w) * 0.4) calc(var(--frame-w) * 0.4); }

    /* ==================== THEMES ==================== */
    .theme-dark { background: linear-gradient(180deg, #1a1a1a, #0d0d0d); }
    .theme-dark .photo-slot { background: rgba(255,255,255,0.08); }

    .theme-cream { background: linear-gradient(180deg, #f5efe5, #e8dfd0); }
    .theme-cream .photo-slot { background: #d8cbb8; border: 2px solid #c9baa5; }
    .theme-cream .frame-footer { color: #8a7a6a; }

    .theme-pink { background: linear-gradient(180deg, #2d1f2f, #1a1218); }
    .theme-pink .photo-slot { background: rgba(244,160,176,0.15); border: 1px solid rgba(244,160,176,0.3); }
    .theme-pink .frame-footer { color: var(--accent); }

    .theme-film { background: #0a0a0a; padding: 0; border-radius: 0; }
    .theme-film .film-wrap { background: #1a1a1a; padding: 6px 16px; position: relative; }
    .theme-film .film-wrap::before, .theme-film .film-wrap::after {
      content: ''; position: absolute; top: 0; bottom: 0; width: 10px;
      background: repeating-linear-gradient(to bottom, transparent 0px, transparent 4px, #0a0a0a 4px, #0a0a0a 9px);
    }
    .theme-film .film-wrap::before { left: 3px; }
    .theme-film .film-wrap::after { right: 3px; }
    .theme-film .photo-slot { background: #f5f5f5; border-radius: 1px; }
    .theme-film .frame-footer { background: #0a0a0a; padding: 8px; margin-top: 0; font-family: 'Courier New', monospace; color: #666; }

    .theme-white { background: #fafafa; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .theme-white .photo-slot { background: #e8e8e8; }
    .theme-white .frame-footer { color: #333; }

    .theme-vintage { background: linear-gradient(150deg, #3d2828, #2a1c1c); border: 4px solid #4a3535; }
    .theme-vintage .photo-slot { background: #f0e8dc; border: 2px solid #e0d5c5; border-radius: 0; }
    .theme-vintage .frame-footer { color: #d4c4b0; }

    .theme-magic { background: linear-gradient(180deg, #1a1a2e, #0f0f1a); position: relative; overflow: visible; }
    .theme-magic::before {
      content: ''; position: absolute; inset: -3px; border-radius: 7px;
      background: linear-gradient(135deg, #ffd700, #ff6b6b, #c678dd, #61afef, #ffd700);
      z-index: -1; animation: magic-border 3s linear infinite; background-size: 300% 300%;
    }
    @keyframes magic-border { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .theme-magic .photo-slot { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,215,0,0.3); }
    .theme-magic .frame-footer { font-family: 'Satisfy', cursive; font-size: 14px; color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.5); letter-spacing: 1px; }
    .theme-magic .mickey { position: absolute; fill: rgba(255,215,0,0.15); filter: drop-shadow(0 0 6px rgba(255,215,0,0.3)); }
    .theme-magic .mickey-tl { top: -12px; left: -8px; width: 32px; }
    .theme-magic .mickey-br { bottom: -10px; right: -8px; width: 28px; transform: rotate(15deg); }

    /* ==================== NEW FRAME THEMES ==================== */
    /* X-Mark Theme */
    .theme-xmark { background: #0a0a0a; padding: 12px; position: relative; }
    .theme-xmark .photo-slot { background: #c41e3a; border-radius: 2px; }
    .theme-xmark .frame-footer { color: rgba(255,255,255,0.6); font-family: 'DM Sans', sans-serif; font-size: 11px; letter-spacing: 3px; }
    .theme-xmark .xmark-icon { position: absolute; top: 8px; right: 8px; font-size: 24px; color: #fff; font-weight: 300; }
    .theme-xmark .date-stamp { position: absolute; bottom: 8px; left: 12px; color: rgba(255,255,255,0.5); font-size: 10px; letter-spacing: 2px; font-family: 'DM Sans', sans-serif; }

    /* Classic B&W Theme */
    .theme-classicbw { background: #ffffff; padding: 14px; border: 3px solid #1a1a1a; }
    .theme-classicbw .photo-slot { background: #e5e5e5; border-radius: 0; }
    .theme-classicbw .photo-slot img { filter: grayscale(100%) !important; }
    .theme-classicbw .frame-footer { color: #1a1a1a; font-family: 'Playfair Display', serif; font-size: 9px; letter-spacing: 1px; margin-top: 12px; }
    .theme-classicbw .text-overlay { position: absolute; top: 10px; left: 0; right: 0; text-align: center; font-size: 8px; color: #1a1a1a; letter-spacing: 2px; text-transform: uppercase; font-family: 'DM Sans', sans-serif; }
    .theme-classicbw .date-stamp { position: absolute; bottom: 8px; left: 14px; color: #1a1a1a; font-size: 10px; letter-spacing: 2px; font-family: 'DM Sans', sans-serif; }

    /* Yellow Theme */
    .theme-yellow { background: #f5d800; padding: 10px; }
    .theme-yellow .photo-slot { background: #d4b800; border-radius: 2px; }
    .theme-yellow .frame-footer { color: #1a1a1a; font-family: 'DM Sans', sans-serif; font-size: 10px; letter-spacing: 2px; font-weight: 600; }
    .theme-yellow .date-stamp { position: absolute; bottom: 6px; left: 10px; color: #1a1a1a; font-size: 10px; letter-spacing: 2px; font-family: 'DM Sans', sans-serif; font-weight: 600; }

    /* Spotify Theme - New Design */
    .theme-spotify {
      background: linear-gradient(170deg, #1a1a35 0%, #12122a 50%, #0a0a18 100%);
      padding: 14px; border-radius: 20px;
      width: calc(var(--frame-w) * 0.75);
    }
    .theme-spotify .photo-grid {
      gap: 5px;
      grid-template-columns: 1fr !important;
      grid-template-rows: repeat(3, calc(var(--frame-w) * 0.32)) !important;
    }
    .theme-spotify .photo-slot {
      background: rgba(255,255,255,0.1); border-radius: 8px;
    }
    .theme-spotify .photo-slot:nth-child(n+4) { display: none; }
    .theme-spotify .frame-footer { display: none; }

    /* Music Player */
    .music-player {
      margin-top: 12px; padding: 12px 10px;
      background: transparent; border-radius: 12px;
    }
    .music-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .album-art {
      width: 44px; height: 44px; border-radius: 8px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; flex-shrink: 0;
    }
    .song-info { flex: 1; min-width: 0; }
    .song-title {
      font-size: 13px; font-weight: 600; color: #fff;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .song-artist { font-size: 11px; color: rgba(255,255,255,0.5); }
    .song-heart { font-size: 16px; opacity: 0.6; }
    .progress-bar {
      height: 3px; background: rgba(255,255,255,0.2);
      border-radius: 2px; margin-bottom: 5px; overflow: hidden;
    }
    .progress-fill { width: 35%; height: 100%; background: #fff; }
    .progress-times {
      display: flex; justify-content: space-between;
      font-size: 9px; color: rgba(255,255,255,0.4); margin-bottom: 10px;
    }
    .player-controls { display: flex; align-items: center; justify-content: center; gap: 22px; }
    .ctrl-btn { font-size: 15px; color: rgba(255,255,255,0.7); }
    .play-btn {
      width: 36px; height: 36px; background: #fff; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #0a0a18; font-size: 13px;
    }

    /* Red Theme */
    .theme-red { background: #c41e3a; padding: 10px; }
    .theme-red .photo-slot { background: #a01830; border-radius: 2px; }
    .theme-red .frame-footer { color: rgba(255,255,255,0.9); font-family: 'DM Sans', sans-serif; font-size: 10px; letter-spacing: 2px; }
    .theme-red .date-stamp { position: absolute; bottom: 6px; left: 10px; color: rgba(255,255,255,0.7); font-size: 10px; letter-spacing: 2px; }

    /* Blue Theme */
    .theme-blue { background: linear-gradient(180deg, #1a3a5c, #0d1f33); padding: 10px; }
    .theme-blue .photo-slot { background: rgba(255,255,255,0.1); border-radius: 2px; }
    .theme-blue .frame-footer { color: rgba(255,255,255,0.8); font-family: 'DM Sans', sans-serif; font-size: 10px; letter-spacing: 2px; }
    .theme-blue .date-stamp { position: absolute; bottom: 6px; left: 10px; color: rgba(255,255,255,0.6); font-size: 10px; letter-spacing: 2px; }

    /* Newspaper Theme */
    .theme-newspaper {
      background: #f5f0e6; padding: 0; border-radius: 4px;
      width: calc(var(--frame-w) * 0.55);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .theme-newspaper .newspaper-header {
      padding: 10px 12px 8px; border-bottom: 2px solid #1a1a1a; text-align: center;
    }
    .theme-newspaper .newspaper-title {
      font-family: 'UnifrakturMaguntia', serif; font-size: 22px; color: #1a1a1a;
      margin-bottom: 6px; line-height: 1;
    }
    .theme-newspaper .newspaper-meta {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 7px; color: #555; text-transform: uppercase; letter-spacing: 1px;
      padding: 0 4px; border-top: 1px solid #1a1a1a; border-bottom: 1px solid #1a1a1a;
      margin: 4px 0; padding: 3px 4px;
    }
    .theme-newspaper .newspaper-headline {
      font-family: 'Playfair Display', serif; font-size: 14px; font-weight: 600;
      color: #1a1a1a; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .theme-newspaper .photo-grid {
      gap: 4px; padding: 10px 12px;
      grid-template-columns: 1fr !important;
      grid-template-rows: repeat(3, calc(var(--frame-w) * 0.28)) !important;
    }
    .theme-newspaper .photo-slot {
      background: #d5cfc2; border-radius: 0; border: 1px solid #c5bfb2;
    }
    .theme-newspaper .photo-slot img { filter: grayscale(100%) contrast(110%); }
    .theme-newspaper .photo-slot:nth-child(n+4) { display: none; }
    .theme-newspaper .frame-footer {
      background: #1a1a1a; color: #f5f0e6; text-align: center;
      font-size: 8px; letter-spacing: 2px; padding: 6px; margin-top: 0;
      font-family: 'DM Sans', sans-serif; text-transform: uppercase;
    }

    /* ==================== BOTTOM PANEL ==================== */
    .bottom-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      z-index: 100;
      transition: transform 0.3s ease;
    }
    .bottom-panel.collapsed {
      transform: translateY(calc(100% - 70px));
    }
    .bottom-panel.collapsed .panel,
    .bottom-panel.collapsed .bottom-nav {
      opacity: 0;
      pointer-events: none;
    }

    .panel-toggle {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 20px;
      background: rgba(10, 10, 10, 0.9);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-3);
      font-size: 10px;
      transition: color 0.2s;
    }
    .panel-toggle:hover { color: var(--text); }
    .bottom-panel.collapsed .panel-toggle { transform: translateX(-50%) rotate(180deg); top: -20px; }

    .panel { display: none; padding: 6px 0; border-bottom: 1px solid var(--border); max-height: 90px; overflow-y: auto; transition: opacity 0.2s; }
    .panel.active { display: block; }
    .panel-scroll { display: flex; gap: 10px; padding: 0 16px; overflow-x: auto; scroll-snap-type: x mandatory; }
    .panel-scroll::-webkit-scrollbar { display: none; }
    .panel-scroll > * { scroll-snap-align: start; }

    /* Filter */
    .filter-item {
      flex-shrink: 0; width: 56px; text-align: center; cursor: pointer;
      padding: 4px; border-radius: 8px; transition: background 0.2s;
    }
    .filter-item:active { background: var(--surface-2); }
    .filter-preview {
      width: 48px; height: 48px; border-radius: 8px;
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fad0c4 100%);
      margin: 0 auto 4px; border: 2px solid transparent;
    }
    .filter-item.active .filter-preview { border-color: var(--accent); }
    .filter-item span { font-size: 11px; color: var(--text-3); font-weight: 500; }
    .filter-item.active span { color: var(--accent); }

    /* Theme */
    .theme-item {
      flex-shrink: 0; width: 56px; padding: 5px; border-radius: 8px;
      background: var(--surface-2); border: 2px solid transparent;
      cursor: pointer; text-align: center; transition: border-color 0.2s;
    }
    .theme-item:active { opacity: 0.8; }
    .theme-item.active { border-color: var(--accent); }
    .theme-preview { width: 100%; height: 32px; border-radius: 5px; margin-bottom: 3px; }
    .theme-item span { font-size: 9px; color: var(--text-2); font-weight: 500; }

    /* Background */
    .bg-item {
      flex-shrink: 0; width: 56px; padding: 5px; border-radius: 8px;
      background: var(--surface-2); border: 2px solid transparent;
      cursor: pointer; text-align: center; transition: border-color 0.2s;
    }
    .bg-item:active { opacity: 0.8; }
    .bg-item.active { border-color: var(--accent); }
    .bg-preview { width: 100%; height: 32px; border-radius: 5px; margin-bottom: 3px; position: relative; overflow: hidden; }
    .bg-item span { font-size: 9px; color: var(--text-2); font-weight: 500; }
    .bg-preview-pattern {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
      font-size: 6px; font-weight: 900; color: rgba(0,0,0,0.15); letter-spacing: -0.5px;
      transform: rotate(-15deg); line-height: 1;
    }

    /* Layout */
    .layout-grid { display: flex; flex-wrap: wrap; gap: 8px; padding: 0 16px; justify-content: flex-start; }
    .layout-item {
      width: 56px; height: 70px; padding: 6px; border-radius: 8px;
      background: var(--surface-2); border: 2px solid transparent;
      cursor: pointer; display: flex; flex-direction: column; align-items: center;
      transition: border-color 0.2s;
    }
    .layout-item:active { opacity: 0.8; }
    .layout-item.active { border-color: var(--accent); }
    .layout-icon { flex: 1; width: 100%; display: grid; gap: 2px; }
    .layout-icon div { background: var(--text-3); border-radius: 2px; min-height: 8px; }
    .layout-item span { font-size: 10px; color: var(--text-3); margin-top: 3px; font-weight: 500; }

    /* Text */
    .text-panel { padding: 12px 16px; max-height: 220px; overflow-y: auto; }
    .input-row { display: flex; gap: 10px; }
    .input-field {
      flex: 1; padding: 12px 14px; border-radius: 10px;
      border: 1px solid var(--border); background: var(--surface-2);
      color: var(--text); font-size: 14px; font-family: inherit;
    }
    .input-field:focus { outline: none; border-color: var(--accent); }
    .input-field::placeholder { color: var(--text-3); }
    .input-field[type="date"] { color-scheme: dark; }
    .input-field[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }

    /* Frame Color Picker */
    .color-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    .color-row-label { font-size: 12px; color: var(--text-2); min-width: 70px; }
    .color-presets { display: flex; gap: 6px; flex-wrap: wrap; flex: 1; }
    .color-preset {
      width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
      border: 2px solid transparent; transition: transform 0.15s, border-color 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .color-preset:hover { transform: scale(1.1); }
    .color-preset.active { border-color: var(--accent); transform: scale(1.1); }
    .color-picker-wrap { position: relative; }
    .color-picker-btn {
      width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
      border: 2px dashed var(--text-3); background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
      transition: transform 0.15s;
    }
    .color-picker-btn:hover { transform: scale(1.1); }
    .color-picker-input {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0; cursor: pointer;
    }

    /* Nav */
    .bottom-nav { display: flex; border-bottom: 1px solid var(--border); }
    .nav-item {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      gap: 2px; padding: 8px 6px; background: none; border: none;
      color: var(--text-3); cursor: pointer; font-family: inherit; position: relative;
      min-height: 40px;
      transition: color 0.2s;
    }
    .nav-item:active { opacity: 0.7; }
    .nav-item.active { color: var(--accent); }
    .nav-item.active::after {
      content: ''; position: absolute; bottom: 0; left: 20%; right: 20%;
      height: 2px; background: var(--accent); border-radius: 2px 2px 0 0;
    }
    .nav-item span:first-child { font-size: 18px; }
    .nav-item span:last-child { font-size: 10px; font-weight: 500; }

    /* Actions */
    .action-bar { display: flex; align-items: center; justify-content: space-around; padding: 8px 16px; }
    .action-btn {
      display: flex; flex-direction: column; align-items: center;
      gap: 3px; padding: 8px 14px; background: none; border: none;
      color: var(--text-2); cursor: pointer; font-family: inherit;
      min-width: 50px; min-height: 44px;
      border-radius: 10px; transition: background 0.2s;
    }
    .action-btn:active { background: var(--surface-2); }
    .action-btn span:first-child { font-size: 20px; }
    .action-btn span:last-child { font-size: 10px; font-weight: 500; }
    .capture-btn {
      width: 56px; height: 56px; border-radius: 50%; background: var(--accent);
      border: 3px solid rgba(255,255,255,0.2); cursor: pointer;
      position: relative; box-shadow: 0 4px 16px rgba(244,160,176,0.5);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .capture-btn:active { transform: scale(0.95); }
    .capture-btn::after {
      content: ''; position: absolute; inset: 4px; border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.15);
    }
    .capture-btn:disabled { background: var(--surface-2); box-shadow: none; opacity: 0.5; transform: none; }
    .capture-btn.recording { animation: pulse-ring 1s infinite; }
    @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(244,160,176,0.6); } 100% { box-shadow: 0 0 0 12px rgba(244,160,176,0); } }

    #canvas { display: none; }

    /* ==================== FULLSCREEN CAMERA ==================== */
    .fullscreen-camera {
      position: absolute;
      inset: 0;
      z-index: 1000;
      background: #000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .fullscreen-camera.active { display: flex; }

    .fullscreen-video-container {
      position: relative;
      width: 100%;
      max-width: 100%;
      aspect-ratio: 3/4;
      max-height: calc(100% - 120px);
      overflow: hidden;
      border-radius: 16px;
      margin: 10px;
    }
    .fullscreen-video-container video {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }
    .fullscreen-video-container video.has-vbg { opacity: 0; }
    .fullscreen-video-container .vbg-canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      border-radius: 16px;
    }

    .fullscreen-countdown {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Playfair Display', serif;
      font-size: 120px;
      font-weight: 600;
      color: white;
      text-shadow: 0 0 40px rgba(255,255,255,0.5), 0 0 80px rgba(0,0,0,0.8);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .fullscreen-countdown.active { opacity: 1; }

    .fullscreen-flash {
      position: absolute;
      inset: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 10;
      border-radius: 16px;
    }
    .fullscreen-flash.active { animation: flash 0.2s; }

    /* Mini Frame Preview */
    .mini-frame-preview {
      position: absolute;
      bottom: 130px;
      left: 16px;
      transform-origin: bottom left;
      transform: scale(0.35);
      pointer-events: none;
      opacity: 0.95;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      border-radius: 8px;
      overflow: visible;
    }
    .mini-frame-preview .photo-frame {
      box-shadow: none;
    }

    .fullscreen-controls {
      position: absolute;
      bottom: 0;
      left: 0; right: 0;
      padding: 20px;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
    }

    .fullscreen-cancel-btn {
      width: 50px; height: 50px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }
    .fullscreen-cancel-btn:active { background: rgba(255,255,255,0.3); }

    .fullscreen-capture-btn {
      width: 80px; height: 80px;
      border-radius: 50%;
      background: var(--accent);
      border: 5px solid rgba(255,255,255,0.4);
      cursor: pointer;
      position: relative;
      box-shadow: 0 4px 30px rgba(244,160,176,0.6);
    }
    .fullscreen-capture-btn::after {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      border: 3px solid rgba(0,0,0,0.15);
    }
    .fullscreen-capture-btn:active { transform: scale(0.95); }
    .fullscreen-capture-btn:disabled { background: #666; box-shadow: none; opacity: 0.5; }

    .fullscreen-photo-count {
      position: absolute;
      top: 20px;
      top: max(20px, env(safe-area-inset-top));
      right: 20px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }

    .fullscreen-filter-indicator {
      position: absolute;
      top: 20px;
      top: max(20px, env(safe-area-inset-top));
      left: 20px;
      background: rgba(0,0,0,0.6);
      color: var(--accent);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }

    /* ==================== MEDIA QUERIES ==================== */
    /* Small phones (< 360px) */
    @media (max-width: 359px) {
      .photo-frame { --frame-w: min(85vw, 260px); }
      .header h1 { font-size: 16px; }
      .filter-item { width: 56px; }
      .filter-preview { width: 48px; height: 48px; }
      .theme-item { width: 60px; padding: 6px; }
      .theme-preview { height: 38px; }
      .layout-item { width: 48px; height: 62px; }
      .capture-btn { width: 58px; height: 58px; }
      .nav-item span:first-child { font-size: 18px; }
      .nav-item span:last-child { font-size: 10px; }
    }

    /* Medium phones (360px - 414px) */
    @media (min-width: 360px) and (max-width: 414px) {
      .photo-frame { --frame-w: min(75vw, 280px); }
    }

    /* Large phones (> 414px) */
    @media (min-width: 415px) {
      .photo-frame { --frame-w: min(70vw, 320px); }
      .filter-item { width: 72px; }
      .filter-preview { width: 64px; height: 64px; }
      .theme-item { width: 76px; }
      .theme-preview { height: 50px; }
      .layout-item { width: 62px; height: 78px; }
      .capture-btn { width: 70px; height: 70px; }
    }

    /* Landscape mode */
    @media (orientation: landscape) and (max-height: 500px) {
      .preview-area { padding: 8px; }
      .photo-frame { --frame-w: min(40vh, 200px); }
      .panel { max-height: 100px; padding: 8px 0; }
      .nav-item { padding: 8px 6px; min-height: 40px; }
      .action-bar { padding: 8px 12px; }
      .capture-btn { width: 50px; height: 50px; }
      .action-btn { padding: 6px 12px; min-height: 40px; }
    }

    /* Very short screens (notch phones in landscape) */
    @media (max-height: 600px) and (orientation: portrait) {
      .photo-frame { --frame-w: min(60vw, 240px); }
      .panel { max-height: 110px; }
    }

    /* Tablet and Desktop */
    @media (min-width: 768px) {
      body {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
      }
      .app {
        max-width: 420px;
        width: 100%;
        height: 100dvh;
        max-height: 900px;
        border-radius: 0;
        box-shadow: 0 0 60px rgba(0,0,0,0.5);
        overflow: hidden;
      }
      .photo-frame { --frame-w: 280px; }
      .preview-area { padding: 24px; }
    }

    /* Large Desktop */
    @media (min-width: 1200px) {
      .app {
        max-width: 480px;
        max-height: 850px;
        border-radius: 24px;
        margin: 20px;
      }
      .photo-frame { --frame-w: 320px; }
      .fullscreen-camera { border-radius: 24px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <button class="header-btn" onclick="resetPhotos()">â†º</button>
      <h1>Coquette Studio</h1>
      <button class="header-btn" onclick="downloadFrame()">â¬‡</button>
    </header>

    <div class="preview-area">
      <div class="photo-frame" id="photoFrame"></div>
    </div>

    <div class="bottom-panel" id="bottomPanel">
      <div class="panel-toggle" onclick="togglePanel()">â–¼</div>
      <div class="panel active" id="panelFilter"><div class="panel-scroll" id="filterScroll"></div></div>
      <div class="panel" id="panelTheme">
        <div class="panel-scroll" id="themeScroll"></div>
        <div class="color-row" id="colorRow" style="padding: 6px 16px 0;">
          <span class="color-row-label">Color</span>
          <div class="color-presets" id="colorPresets">
            <div class="color-preset" style="background:#1a1a1a" data-color="#1a1a1a" onclick="setFrameColor('#1a1a1a')"></div>
            <div class="color-preset" style="background:#ffffff" data-color="#ffffff" onclick="setFrameColor('#ffffff')"></div>
            <div class="color-preset" style="background:#f5efe5" data-color="#f5efe5" onclick="setFrameColor('#f5efe5')"></div>
            <div class="color-preset" style="background:#2d1f2f" data-color="#2d1f2f" onclick="setFrameColor('#2d1f2f')"></div>
            <div class="color-preset" style="background:#c41e3a" data-color="#c41e3a" onclick="setFrameColor('#c41e3a')"></div>
            <div class="color-preset" style="background:#1a3a5c" data-color="#1a3a5c" onclick="setFrameColor('#1a3a5c')"></div>
            <div class="color-preset" style="background:#f5d800" data-color="#f5d800" onclick="setFrameColor('#f5d800')"></div>
            <div class="color-preset" style="background:#1db954" data-color="#1db954" onclick="setFrameColor('#1db954')"></div>
            <div class="color-picker-wrap">
              <div class="color-picker-btn"></div>
              <input type="color" class="color-picker-input" id="customColorPicker" value="#1a1a1a" onchange="setFrameColor(this.value)">
            </div>
          </div>
        </div>
      </div>
      <div class="panel" id="panelBg">
        <div class="panel-scroll" id="bgScroll"></div>
        <div class="vbg-settings" id="vbgSettings" style="display:none; padding: 8px 16px;">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
            <span style="font-size:11px; color:var(--text-2); min-width:60px;">Smooth</span>
            <input type="range" id="edgeBlurSlider" min="0" max="20" value="8" style="flex:1; accent-color:var(--accent);" oninput="edgeBlur=parseInt(this.value)">
            <span style="font-size:10px; color:var(--text-3); width:24px;" id="blurValue">8</span>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:11px; color:var(--text-2); min-width:60px;">Precision</span>
            <input type="range" id="thresholdSlider" min="40" max="90" value="65" style="flex:1; accent-color:var(--accent);" oninput="maskThreshold=parseInt(this.value)/100">
            <span style="font-size:10px; color:var(--text-3); width:24px;" id="thresholdValue">65</span>
          </div>
        </div>
      </div>
      <div class="panel" id="panelLayout"><div class="layout-grid" id="layoutGrid"></div></div>
      <div class="panel text-panel" id="panelText">
        <!-- Spotify inputs -->
        <div id="spotifyInputs" style="display:none;">
          <div class="input-row" style="margin-bottom: 10px;">
            <input type="text" class="input-field" id="spotifySong" placeholder="ðŸŽµ Song name" value="I Wanna Be Yours" oninput="updatePreview()">
          </div>
          <div class="input-row">
            <input type="text" class="input-field" id="spotifyArtist" placeholder="ðŸŽ¤ Artist" value="Arctic Monkeys" oninput="updatePreview()">
          </div>
        </div>
        <!-- Newspaper inputs -->
        <div id="newspaperInputs" style="display:none;">
          <div class="input-row" style="margin-bottom: 10px;">
            <input type="text" class="input-field" id="newspaperHeadline" placeholder="ðŸ“° Headline" value="MIKHA AT 21!" oninput="updatePreview()">
          </div>
          <div class="input-row" style="margin-bottom: 10px;">
            <input type="text" class="input-field" id="newspaperDate" placeholder="ðŸ“… Date" value="NOV. 8, 2024" oninput="updatePreview()">
            <input type="text" class="input-field" id="newspaperLocation" placeholder="ðŸ“ Location" value="WHITESPACE MANILA" oninput="updatePreview()">
          </div>
          <div class="input-row">
            <input type="text" class="input-field" id="newspaperEdition" placeholder="Edition" value="BIRTHDAY EDITION" oninput="updatePreview()">
          </div>
        </div>
        <!-- Default inputs (Title, Footer, Date) -->
        <div id="defaultInputs">
          <div class="input-row" style="margin-bottom: 10px;">
            <input type="text" class="input-field" id="headerInput" placeholder="Title / Caption" oninput="updatePreview()">
            <input type="text" class="input-field" id="footerInput" placeholder="Footer" value="COQUETTE STUDIO" oninput="updatePreview()">
          </div>
          <div class="input-row">
            <input type="date" class="input-field" id="dateInput" oninput="updatePreview()">
          </div>
        </div>
      </div>

      <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('filter')" id="tabFilter"><span>âœ¨</span><span>Filter</span></button>
        <button class="nav-item" onclick="switchTab('theme')" id="tabTheme"><span>ðŸŽ¨</span><span>Theme</span></button>
        <button class="nav-item" onclick="switchTab('bg')" id="tabBg"><span>ðŸ–¼</span><span>BG</span></button>
        <button class="nav-item" onclick="switchTab('layout')" id="tabLayout"><span>âŠž</span><span>Layout</span></button>
        <button class="nav-item" onclick="switchTab('text')" id="tabText"><span>Aa</span><span>Text</span></button>
      </nav>

      <div class="action-bar">
        <button class="action-btn" onclick="toggleCamera()"><span id="camIcon">ðŸ“·</span><span id="camText">Start</span></button>
        <button class="capture-btn" id="captureBtn" onclick="startCountdown()" disabled></button>
        <button class="action-btn" onclick="downloadFrame()"><span>ðŸ’¾</span><span>Save</span></button>
      </div>
    </div>

    <!-- Fullscreen Camera Overlay (inside app container) -->
    <div class="fullscreen-camera" id="fullscreenCamera">
      <div class="fullscreen-video-container">
        <video id="fullscreenVideo" autoplay playsinline muted></video>
        <canvas id="fullscreenVbgCanvas" class="vbg-canvas" style="display:none;"></canvas>
        <div class="fullscreen-countdown" id="fullscreenCountdown"></div>
        <div class="fullscreen-flash" id="fullscreenFlash"></div>
      </div>
      <div class="fullscreen-filter-indicator" id="filterIndicator">Original</div>
      <div class="fullscreen-photo-count" id="photoCount">1/4</div>
      <div class="mini-frame-preview" id="miniFramePreview"></div>
      <div class="fullscreen-controls">
        <button class="fullscreen-cancel-btn" onclick="exitFullscreenCamera()">âœ•</button>
        <button class="fullscreen-capture-btn" id="fullscreenCaptureBtn" onclick="fullscreenCapture()"></button>
        <div style="width:50px"></div>
      </div>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <script>
    const themes = [
      { id: 'white', name: 'White', bg: '#fafafa' },
      { id: 'dark', name: 'Dark', bg: 'linear-gradient(135deg, #1a1a1a, #0d0d0d)' },
      { id: 'cream', name: 'Cream', bg: 'linear-gradient(135deg, #f5efe5, #e8dfd0)' },
      { id: 'pink', name: 'Pink', bg: 'linear-gradient(135deg, #2d1f2f, #1a1218)' },
      { id: 'film', name: 'Film', bg: '#1a1a1a' },
      { id: 'vintage', name: 'Vintage', bg: 'linear-gradient(135deg, #3d2828, #2a1c1c)' },
      { id: 'magic', name: 'Magic', bg: 'linear-gradient(135deg, #1a1a2e, #0f0f1a)' },
      { id: 'xmark', name: 'X-Mark', bg: '#0a0a0a' },
      { id: 'classicbw', name: 'Classic', bg: '#ffffff' },
      { id: 'spotify', name: 'Spotify', bg: 'linear-gradient(170deg, #1a1a35, #0a0a18)' },
      { id: 'newspaper', name: 'News', bg: '#f5f0e6' },
    ];

    const layouts = [
      { id: 'strip3', name: 'A', slots: 3, icon: [['1fr'],['1fr'],['1fr']] },
      { id: 'strip4', name: 'B', slots: 4, icon: [['1fr'],['1fr'],['1fr'],['1fr']] },
      { id: 'top1-bot2', name: 'C', slots: 3, icon: [['1fr 1fr','span2'],['1fr',''],['','1fr']] },
      { id: 'grid2x2', name: 'D', slots: 4, icon: [['1fr','1fr'],['1fr','1fr']] },
      { id: 'left1-right3', name: 'E', slots: 4, icon: [['span3','1fr'],['','1fr'],['','1fr']] },
      { id: 'top2-bot1', name: 'F', slots: 3, icon: [['1fr','1fr'],['1fr 1fr','span2']] },
      { id: 'left3-right1', name: 'G', slots: 4, icon: [['1fr','span3'],['1fr',''],['1fr','']] },
      { id: 'h2', name: 'H', slots: 2, icon: [['1fr'],['1fr']] },
      { id: 'big-small', name: 'I', slots: 2, icon: [['2fr','1fr']] },
      { id: 'v2', name: 'J', slots: 2, icon: [['1fr','1fr']] },
      { id: 'single', name: 'K', slots: 1, icon: [['1fr']] },
      { id: 'portrait', name: 'L', slots: 1, icon: [['1fr','tall']] },
      { id: 't3-b1', name: 'M', slots: 4, icon: [['1fr','1fr','1fr'],['span3']] },
      { id: 't1-b3', name: 'N', slots: 4, icon: [['span3'],['1fr','1fr','1fr']] },
      { id: 'grid3x2', name: 'O', slots: 6, icon: [['1fr','1fr','1fr'],['1fr','1fr','1fr']] },
      { id: 'small-big', name: 'P', slots: 2, icon: [['1fr','2fr']] },
    ];

    const filters = [
      { id: 'none', name: 'Original', css: 'none' },
      { id: 'bw', name: 'B&W', css: 'grayscale(100%)' },
      { id: 'sepia', name: 'Sepia', css: 'sepia(70%)' },
      { id: 'retro', name: 'Retro', css: 'sepia(40%) contrast(90%)' },
      { id: 'film', name: 'Film', css: 'sepia(20%) saturate(140%)' },
      { id: 'fade', name: 'Fade', css: 'contrast(85%) brightness(115%) saturate(75%)' },
      { id: 'warm', name: 'Warm', css: 'sepia(15%) saturate(130%)' },
      { id: 'cool', name: 'Cool', css: 'saturate(90%) hue-rotate(15deg)' },
      { id: 'pink', name: 'Pink', css: 'saturate(120%) hue-rotate(-10deg)' },
      { id: 'vivid', name: 'Vivid', css: 'saturate(150%) contrast(105%)' },
      { id: 'noir', name: 'Noir', css: 'grayscale(100%) contrast(130%) brightness(90%)' },
      { id: 'soft', name: 'Soft', css: 'brightness(105%) contrast(90%) saturate(90%)' },
    ];

    // Virtual backgrounds (behind the person)
    const virtualBackgrounds = [
      { id: 'none', name: 'None', type: 'none', color: null },
      { id: 'curtain-red', name: 'Red', type: 'curtain', color: '#8B0000' },
      { id: 'curtain-blue', name: 'Blue', type: 'curtain', color: '#1a3a5c' },
      { id: 'curtain-green', name: 'Green', type: 'curtain', color: '#2d5a2d' },
      { id: 'curtain-purple', name: 'Purple', type: 'curtain', color: '#4a2a5a' },
      { id: 'curtain-gold', name: 'Gold', type: 'curtain', color: '#8B7500' },
      { id: 'solid-white', name: 'White', type: 'solid', color: '#ffffff' },
      { id: 'solid-pink', name: 'Pink', type: 'solid', color: '#ffb6c1' },
      { id: 'solid-yellow', name: 'Yellow', type: 'solid', color: '#f5d800' },
      { id: 'solid-cyan', name: 'Cyan', type: 'solid', color: '#00CED1' },
      { id: 'gradient-sunset', name: 'Sunset', type: 'gradient', colors: ['#ff7e5f', '#feb47b'] },
      { id: 'gradient-ocean', name: 'Ocean', type: 'gradient', colors: ['#2193b0', '#6dd5ed'] },
      { id: 'gradient-purple', name: 'Violet', type: 'gradient', colors: ['#834d9b', '#d04ed6'] },
    ];

    // Default to white theme (index 0)
    let photos = [], theme = themes[0], layout = layouts[1], filter = filters[0], virtualBg = virtualBackgrounds[0];
    let currentTab = 'filter', stream = null, cameraOn = false, isFullscreen = false;
    let customFrameColor = null;

    // Themes that support custom frame color
    const customColorThemes = ['dark', 'cream', 'pink', 'white', 'spotify'];
    const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
    const fullscreenCamera = document.getElementById('fullscreenCamera');
    const fullscreenVideo = document.getElementById('fullscreenVideo');
    const fullscreenCountdown = document.getElementById('fullscreenCountdown');
    const fullscreenFlash = document.getElementById('fullscreenFlash');
    const fullscreenCaptureBtn = document.getElementById('fullscreenCaptureBtn');
    const photoCountEl = document.getElementById('photoCount');
    const filterIndicatorEl = document.getElementById('filterIndicator');
    const miniFramePreview = document.getElementById('miniFramePreview');

    // Virtual background segmentation
    let selfieSegmentation = null;
    let vbgCanvas = null;
    let vbgCtx = null;
    let vbgVideo = null;
    let vbgAnimationId = null;
    let segmentationReady = false;

    // For mask processing
    let maskCanvas = null;
    let maskCtx = null;
    let edgeBlur = 8; // Edge feathering amount
    let maskThreshold = 0.65; // Higher = stricter person detection (0.5-0.9)

    // Initialize MediaPipe Selfie Segmentation
    async function initSegmentation() {
      if (selfieSegmentation) return;
      try {
        selfieSegmentation = new SelfieSegmentation({
          locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
        });
        selfieSegmentation.setOptions({ modelSelection: 1, selfieMode: true });
        selfieSegmentation.onResults(onSegmentationResults);
        segmentationReady = true;
        console.log('Segmentation ready');
      } catch (e) {
        console.error('Segmentation init failed:', e);
      }
    }

    function onSegmentationResults(results) {
      if (!vbgCtx || !vbgCanvas) return;
      const w = vbgCanvas.width;
      const h = vbgCanvas.height;

      // Create mask canvas if needed
      if (!maskCanvas) {
        maskCanvas = document.createElement('canvas');
        maskCtx = maskCanvas.getContext('2d', { willReadFrequently: true });
      }
      maskCanvas.width = w;
      maskCanvas.height = h;

      // Draw and process the segmentation mask
      maskCtx.drawImage(results.segmentationMask, 0, 0, w, h);

      // Apply threshold to clean up the mask
      const imageData = maskCtx.getImageData(0, 0, w, h);
      const data = imageData.data;
      const threshold = maskThreshold * 255;

      for (let i = 0; i < data.length; i += 4) {
        // Use red channel as mask value
        const maskValue = data[i];
        if (maskValue > threshold) {
          data[i] = data[i + 1] = data[i + 2] = 255;
          data[i + 3] = 255;
        } else if (maskValue > threshold * 0.5) {
          // Soft edge transition
          const alpha = (maskValue - threshold * 0.5) / (threshold * 0.5);
          data[i] = data[i + 1] = data[i + 2] = 255;
          data[i + 3] = Math.round(alpha * 255);
        } else {
          data[i] = data[i + 1] = data[i + 2] = 0;
          data[i + 3] = 0;
        }
      }
      maskCtx.putImageData(imageData, 0, 0);

      // Apply blur for edge feathering
      vbgCtx.save();
      vbgCtx.clearRect(0, 0, w, h);

      // Draw background
      drawVirtualBackground(vbgCtx, w, h);

      // Apply feathered mask
      vbgCtx.filter = `blur(${edgeBlur}px)`;
      vbgCtx.globalCompositeOperation = 'destination-in';
      vbgCtx.drawImage(maskCanvas, 0, 0, w, h);
      vbgCtx.filter = 'none';

      // Composite background behind
      vbgCtx.globalCompositeOperation = 'destination-over';
      drawVirtualBackground(vbgCtx, w, h);

      // Draw the original person on top
      vbgCtx.globalCompositeOperation = 'source-over';

      // Create a temp canvas with person only
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = w;
      tempCanvas.height = h;
      const tempCtx = tempCanvas.getContext('2d');

      // Draw person
      tempCtx.drawImage(results.image, 0, 0, w, h);

      // Apply processed mask
      tempCtx.globalCompositeOperation = 'destination-in';
      tempCtx.filter = `blur(${edgeBlur / 2}px)`;
      tempCtx.drawImage(maskCanvas, 0, 0, w, h);

      // Draw person with background
      vbgCtx.clearRect(0, 0, w, h);
      drawVirtualBackground(vbgCtx, w, h);
      vbgCtx.drawImage(tempCanvas, 0, 0);

      vbgCtx.restore();
    }

    function drawVirtualBackground(ctx, w, h) {
      if (virtualBg.type === 'none') return;

      if (virtualBg.type === 'solid') {
        ctx.fillStyle = virtualBg.color;
        ctx.fillRect(0, 0, w, h);
      } else if (virtualBg.type === 'curtain') {
        // Draw curtain-like background with folds
        const baseColor = virtualBg.color;
        ctx.fillStyle = baseColor;
        ctx.fillRect(0, 0, w, h);

        // Add curtain fold effect
        const foldWidth = w / 12;
        for (let i = 0; i < 12; i++) {
          const x = i * foldWidth;
          const gradient = ctx.createLinearGradient(x, 0, x + foldWidth, 0);
          const lightColor = adjustBrightness(baseColor, 20);
          const darkColor = adjustBrightness(baseColor, -30);
          gradient.addColorStop(0, darkColor);
          gradient.addColorStop(0.3, lightColor);
          gradient.addColorStop(0.7, lightColor);
          gradient.addColorStop(1, darkColor);
          ctx.fillStyle = gradient;
          ctx.fillRect(x, 0, foldWidth, h);
        }
      } else if (virtualBg.type === 'gradient') {
        const gradient = ctx.createLinearGradient(0, 0, 0, h);
        gradient.addColorStop(0, virtualBg.colors[0]);
        gradient.addColorStop(1, virtualBg.colors[1]);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, w, h);
      }
    }

    function adjustBrightness(hex, percent) {
      const num = parseInt(hex.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = Math.max(0, Math.min(255, (num >> 16) + amt));
      const G = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amt));
      const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
      return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
    }

    async function processVideoFrame() {
      if (!cameraOn || !selfieSegmentation || !vbgVideo || virtualBg.type === 'none') {
        vbgAnimationId = requestAnimationFrame(processVideoFrame);
        return;
      }
      try {
        await selfieSegmentation.send({ image: vbgVideo });
      } catch (e) {}
      vbgAnimationId = requestAnimationFrame(processVideoFrame);
    }

    function startVirtualBackground(video, canvasEl) {
      vbgVideo = video;
      vbgCanvas = canvasEl;
      vbgCtx = canvasEl.getContext('2d');

      if (virtualBg.type !== 'none' && segmentationReady) {
        vbgCanvas.width = video.videoWidth || 640;
        vbgCanvas.height = video.videoHeight || 480;
        processVideoFrame();
      }
    }

    function stopVirtualBackground() {
      if (vbgAnimationId) {
        cancelAnimationFrame(vbgAnimationId);
        vbgAnimationId = null;
      }
    }

    // ==================== PANEL TOGGLE ====================
    let panelCollapsed = false;

    function togglePanel() {
      const panel = document.getElementById('bottomPanel');
      panelCollapsed = !panelCollapsed;
      panel.classList.toggle('collapsed', panelCollapsed);
    }

    // Auto-collapse panel when tapping on preview area
    document.addEventListener('click', (e) => {
      const previewArea = document.querySelector('.preview-area');
      const bottomPanel = document.getElementById('bottomPanel');
      if (previewArea && previewArea.contains(e.target) && !e.target.classList.contains('editable-text')) {
        if (!panelCollapsed) {
          panelCollapsed = true;
          bottomPanel.classList.add('collapsed');
        }
      }
    });

    // ==================== TAP-TO-EDIT ====================
    function setupEditableText() {
      // Setup event delegation for editable text
      document.getElementById('photoFrame').addEventListener('click', (e) => {
        const editable = e.target.closest('.editable-text');
        if (editable) {
          e.stopPropagation();
          editable.focus();
          // Select all text
          const range = document.createRange();
          range.selectNodeContents(editable);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }
      });

      document.getElementById('photoFrame').addEventListener('blur', (e) => {
        if (e.target.classList.contains('editable-text')) {
          const field = e.target.dataset.field;
          const value = e.target.textContent.trim();
          syncEditableToInput(field, value);
        }
      }, true);

      document.getElementById('photoFrame').addEventListener('keydown', (e) => {
        if (e.target.classList.contains('editable-text') && e.key === 'Enter') {
          e.preventDefault();
          e.target.blur();
        }
      });
    }

    function syncEditableToInput(field, value) {
      const inputMap = {
        'footer': 'footerInput',
        'header': 'headerInput',
        'headline': 'newspaperHeadline',
        'newsDate': 'newspaperDate',
        'newsLocation': 'newspaperLocation',
        'newsEdition': 'newspaperEdition',
        'songTitle': 'spotifySong',
        'songArtist': 'spotifyArtist'
      };
      const inputId = inputMap[field];
      if (inputId) {
        document.getElementById(inputId).value = value;
      }
    }

    function init() {
      renderFilters();
      renderThemes();
      renderBackgrounds();
      renderLayouts();
      updateColorPickerVisibility();
      toggleTextInputs();
      updatePreview();
      initSegmentation();
      setupEditableText();
    }

    function renderFilters() {
      document.getElementById('filterScroll').innerHTML = filters.map(f =>
        `<div class="filter-item ${f.id === filter.id ? 'active' : ''}" onclick="selectFilter('${f.id}')">
          <div class="filter-preview" style="filter:${f.css}"></div><span>${f.name}</span>
        </div>`).join('');
    }

    function renderThemes() {
      document.getElementById('themeScroll').innerHTML = themes.map(t =>
        `<div class="theme-item ${t.id === theme.id ? 'active' : ''}" onclick="selectTheme('${t.id}')">
          <div class="theme-preview" style="background:${t.bg}"></div><span>${t.name}</span>
        </div>`).join('');
    }

    function renderBackgrounds() {
      document.getElementById('bgScroll').innerHTML = virtualBackgrounds.map(b => {
        let bgStyle = '';
        if (b.type === 'none') {
          bgStyle = 'background: linear-gradient(45deg, #333 25%, #444 25%, #444 50%, #333 50%, #333 75%, #444 75%); background-size: 8px 8px;';
        } else if (b.type === 'solid' || b.type === 'curtain') {
          bgStyle = `background: ${b.color};`;
        } else if (b.type === 'gradient') {
          bgStyle = `background: linear-gradient(180deg, ${b.colors[0]}, ${b.colors[1]});`;
        }
        return `<div class="bg-item ${b.id === virtualBg.id ? 'active' : ''}" onclick="selectBackground('${b.id}')">
          <div class="bg-preview" style="${bgStyle}"></div><span>${b.name}</span>
        </div>`;
      }).join('');
    }

    function selectBackground(id) {
      virtualBg = virtualBackgrounds.find(b => b.id === id);
      renderBackgrounds();
      // Show/hide settings
      const vbgSettings = document.getElementById('vbgSettings');
      if (vbgSettings) {
        vbgSettings.style.display = virtualBg.type !== 'none' ? 'block' : 'none';
      }
      // Restart video processing with new background
      if (cameraOn) {
        stopVirtualBackground();
        updatePreview();
      }
    }

    // Update slider display values
    document.addEventListener('DOMContentLoaded', () => {
      const blurSlider = document.getElementById('edgeBlurSlider');
      const thresholdSlider = document.getElementById('thresholdSlider');
      if (blurSlider) {
        blurSlider.addEventListener('input', (e) => {
          document.getElementById('blurValue').textContent = e.target.value;
        });
      }
      if (thresholdSlider) {
        thresholdSlider.addEventListener('input', (e) => {
          document.getElementById('thresholdValue').textContent = e.target.value;
        });
      }
    });

    function renderLayouts() {
      const icons = {
        'strip3': '<div style="grid-template-rows:1fr 1fr 1fr"><div></div><div></div><div></div></div>',
        'strip4': '<div style="grid-template-rows:1fr 1fr 1fr 1fr"><div></div><div></div><div></div><div></div></div>',
        'grid2x2': '<div style="grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr"><div></div><div></div><div></div><div></div></div>',
        'top1-bot2': '<div style="grid-template-columns:1fr 1fr;grid-template-rows:2fr 1fr"><div style="grid-column:span 2"></div><div></div><div></div></div>',
        'top2-bot1': '<div style="grid-template-columns:1fr 1fr;grid-template-rows:1fr 2fr"><div></div><div></div><div style="grid-column:span 2"></div></div>',
        'left1-right3': '<div style="grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr 1fr"><div style="grid-row:span 3"></div><div></div><div></div><div></div></div>',
        'left3-right1': '<div style="grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr 1fr"><div></div><div style="grid-row:span 3"></div><div></div><div></div></div>',
        'h2': '<div style="grid-template-rows:1fr 1fr"><div></div><div></div></div>',
        'v2': '<div style="grid-template-columns:1fr 1fr"><div></div><div></div></div>',
        'big-small': '<div style="grid-template-columns:2fr 1fr"><div></div><div></div></div>',
        'small-big': '<div style="grid-template-columns:1fr 2fr"><div></div><div></div></div>',
        'single': '<div><div></div></div>',
        'portrait': '<div style="height:100%"><div style="height:100%"></div></div>',
        't3-b1': '<div style="grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 2fr"><div></div><div></div><div></div><div style="grid-column:span 3"></div></div>',
        't1-b3': '<div style="grid-template-columns:1fr 1fr 1fr;grid-template-rows:2fr 1fr"><div style="grid-column:span 3"></div><div></div><div></div><div></div></div>',
        'grid3x2': '<div style="grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr"><div></div><div></div><div></div><div></div><div></div><div></div></div>',
      };
      document.getElementById('layoutGrid').innerHTML = layouts.map(l =>
        `<div class="layout-item ${l.id === layout.id ? 'active' : ''}" onclick="selectLayout('${l.id}')">
          <div class="layout-icon" style="display:grid;gap:1px">${icons[l.id]}</div><span>${l.name}</span>
        </div>`).join('');
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
      document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
      document.getElementById('panel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
    }

    function selectFilter(id) { filter = filters.find(f => f.id === id); renderFilters(); updatePreview(); }
    function selectTheme(id) {
      theme = themes.find(t => t.id === id);
      customFrameColor = null; // Reset custom color when changing theme
      updateColorPickerVisibility();
      toggleTextInputs();
      renderThemes();
      updatePreview();
    }
    function selectLayout(id) { layout = layouts.find(l => l.id === id); if (photos.length > layout.slots) photos = photos.slice(0, layout.slots); renderLayouts(); updatePreview(); }

    function setFrameColor(color) {
      customFrameColor = color;
      document.querySelectorAll('.color-preset').forEach(el => {
        el.classList.toggle('active', el.dataset.color === color);
      });
      document.getElementById('customColorPicker').value = color;
      updatePreview();
    }

    function updateColorPickerVisibility() {
      const colorRow = document.getElementById('colorRow');
      if (colorRow) {
        colorRow.style.display = customColorThemes.includes(theme.id) ? 'flex' : 'none';
      }
    }

    function toggleTextInputs() {
      const spotifyInputs = document.getElementById('spotifyInputs');
      const newspaperInputs = document.getElementById('newspaperInputs');
      const defaultInputs = document.getElementById('defaultInputs');
      spotifyInputs.style.display = 'none';
      newspaperInputs.style.display = 'none';
      defaultInputs.style.display = 'none';
      if (theme.id === 'spotify') {
        spotifyInputs.style.display = 'block';
      } else if (theme.id === 'newspaper') {
        newspaperInputs.style.display = 'block';
      } else {
        defaultInputs.style.display = 'block';
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
      return `${months[d.getMonth()]} ${String(d.getDate()).padStart(2, '0')} ${d.getFullYear()}`;
    }

    function formatDateNumeric(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return `${String(d.getMonth() + 1).padStart(2, '0')} ${String(d.getDate()).padStart(2, '0')} ${d.getFullYear()}`;
    }

    function getEffectiveSlots() {
      // Spotify and Newspaper themes always use 3 slots
      if (theme.id === 'spotify' || theme.id === 'newspaper') return 3;
      return layout.slots;
    }

    function updatePreview() {
      const frame = document.getElementById('photoFrame');
      frame.className = `photo-frame theme-${theme.id} layout-${layout.id}`;
      // Apply custom frame color if set and theme supports it
      if (customFrameColor && customColorThemes.includes(theme.id)) {
        frame.style.background = customFrameColor;
      } else {
        frame.style.background = '';
      }
      const footer = document.getElementById('footerInput').value || '';
      const header = document.getElementById('headerInput').value || '';
      const dateVal = document.getElementById('dateInput').value || '';
      const songName = document.getElementById('spotifySong').value || 'SNOOZE';
      const artistName = document.getElementById('spotifyArtist').value || 'SZA';
      const newsHeadline = document.getElementById('newspaperHeadline').value || 'HEADLINE HERE';
      const newsDate = document.getElementById('newspaperDate').value || 'DATE';
      const newsLocation = document.getElementById('newspaperLocation').value || 'LOCATION';
      const newsEdition = document.getElementById('newspaperEdition').value || 'SPECIAL EDITION';

      const effectiveSlots = getEffectiveSlots();
      let slotsHtml = '', liveAdded = false;
      const useVbg = virtualBg.type !== 'none';
      for (let i = 0; i < effectiveSlots; i++) {
        if (photos[i]) {
          slotsHtml += `<div class="photo-slot"><img src="${photos[i]}" style="filter:${filter.css}"><button class="remove-btn" onclick="removePhoto(${i})">âœ•</button></div>`;
        } else if (cameraOn && !liveAdded) {
          const videoClass = useVbg ? 'has-vbg' : '';
          const canvasHtml = useVbg ? `<canvas class="vbg-canvas" id="liveVbgCanvas" style="filter:${filter.css}"></canvas>` : '';
          slotsHtml += `<div class="photo-slot" id="liveSlot"><video id="liveVideo" class="${videoClass}" autoplay playsinline muted style="filter:${filter.css}"></video>${canvasHtml}<span class="live-badge">â— LIVE</span><div class="countdown-overlay" id="countdown"></div><div class="flash-overlay" id="flash"></div></div>`;
          liveAdded = true;
        } else {
          slotsHtml += `<div class="photo-slot"><span class="placeholder">${i + 1}</span></div>`;
        }
      }

      let gridHtml = `<div class="photo-grid">${slotsHtml}</div>`;
      let footerHtml = `<div class="frame-footer"><span class="editable-text" contenteditable="true" data-field="footer" data-placeholder="Footer">${footer}</span></div>`;

      // Theme-specific elements
      let extraHtml = '';
      const dateFormatted = formatDate(dateVal);
      const dateNumeric = formatDateNumeric(dateVal);

      if (theme.id === 'magic') {
        extraHtml = `<svg class="mickey mickey-tl" viewBox="0 0 128 128"><circle cx="64" cy="72" r="40"/><circle cx="32" cy="32" r="24"/><circle cx="96" cy="32" r="24"/></svg><svg class="mickey mickey-br" viewBox="0 0 128 128"><circle cx="64" cy="72" r="40"/><circle cx="32" cy="32" r="24"/><circle cx="96" cy="32" r="24"/></svg>`;
      } else if (theme.id === 'xmark') {
        extraHtml = `<span class="xmark-icon">âœ•</span>`;
        if (dateVal) extraHtml += `<span class="date-stamp">${dateNumeric}</span>`;
      } else if (theme.id === 'classicbw') {
        extraHtml += `<span class="text-overlay"><span class="editable-text" contenteditable="true" data-field="header" data-placeholder="Title">${header}</span></span>`;
        if (dateVal) extraHtml += `<span class="date-stamp">${dateFormatted}</span>`;
      } else if (theme.id === 'yellow' || theme.id === 'red' || theme.id === 'blue') {
        if (dateVal) extraHtml += `<span class="date-stamp">${dateFormatted}</span>`;
      } else if (theme.id === 'spotify') {
        extraHtml = `
          <div class="music-player">
            <div class="music-header">
              <div class="album-art">ðŸŽµ</div>
              <div class="song-info">
                <div class="song-title"><span class="editable-text" contenteditable="true" data-field="songTitle" data-placeholder="Song">${songName}</span></div>
                <div class="song-artist"><span class="editable-text" contenteditable="true" data-field="songArtist" data-placeholder="Artist">${artistName}</span></div>
              </div>
              <span class="song-heart">â™¡</span>
            </div>
            <div class="progress-bar"><div class="progress-fill"></div></div>
            <div class="progress-times"><span>1:24</span><span>-2:18</span></div>
            <div class="player-controls">
              <span class="ctrl-btn">â®</span>
              <div class="play-btn">â–¶</div>
              <span class="ctrl-btn">â­</span>
            </div>
          </div>
        `;
        footerHtml = ''; // Hide footer for Spotify theme
      }

      if (theme.id === 'film') {
        frame.innerHTML = `<div class="film-wrap">${gridHtml}</div>${footerHtml}`;
      } else if (theme.id === 'newspaper') {
        frame.innerHTML = `
          <div class="newspaper-header">
            <div class="newspaper-title">The Birthday Times</div>
            <div class="newspaper-meta">
              <span class="editable-text" contenteditable="true" data-field="newsDate" data-placeholder="Date">${newsDate}</span>
              <span class="editable-text" contenteditable="true" data-field="newsLocation" data-placeholder="Location">${newsLocation}</span>
            </div>
            <div class="newspaper-headline"><span class="editable-text" contenteditable="true" data-field="headline" data-placeholder="Headline">${newsHeadline}</span></div>
          </div>
          ${gridHtml}
          <div class="frame-footer"><span class="editable-text" contenteditable="true" data-field="newsEdition" data-placeholder="Edition">${newsEdition}</span></div>
        `;
      } else {
        frame.innerHTML = `${gridHtml}${footerHtml}${extraHtml}`;
      }

      if (cameraOn && stream) {
        const v = document.getElementById('liveVideo');
        if (v && v.srcObject !== stream) {
          v.srcObject = stream;
          // Start virtual background if enabled
          if (virtualBg.type !== 'none') {
            v.onloadedmetadata = () => {
              const vbgCanvas = document.getElementById('liveVbgCanvas');
              if (vbgCanvas && segmentationReady) {
                startVirtualBackground(v, vbgCanvas);
              }
            };
          }
        }
      }
      document.getElementById('captureBtn').disabled = !cameraOn || photos.length >= getEffectiveSlots();
      document.getElementById('captureBtn').classList.toggle('recording', cameraOn);
    }

    function removePhoto(i) { photos.splice(i, 1); updatePreview(); }
    function resetPhotos() { photos = []; updatePreview(); }

    async function toggleCamera() { cameraOn ? stopCamera() : await startCamera(); }
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } } });
        cameraOn = true;
        document.getElementById('camIcon').textContent = 'â¹';
        document.getElementById('camText').textContent = 'Stop';
        updatePreview();
      } catch (e) { alert('Cannot access camera'); }
    }
    function stopCamera() {
      if (isFullscreen) exitFullscreenCamera();
      stopVirtualBackground();
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      cameraOn = false;
      document.getElementById('camIcon').textContent = 'ðŸ“·';
      document.getElementById('camText').textContent = 'Start';
      updatePreview();
    }

    function startCountdown() {
      if (!cameraOn || photos.length >= getEffectiveSlots()) return;
      // Open fullscreen camera mode
      openFullscreenCamera();
    }

    function openFullscreenCamera() {
      isFullscreen = true;
      fullscreenCamera.classList.add('active');
      fullscreenVideo.srcObject = stream;
      fullscreenVideo.style.filter = filter.css;
      filterIndicatorEl.textContent = filter.name;

      // Setup virtual background for fullscreen
      const fsVbgCanvas = document.getElementById('fullscreenVbgCanvas');
      if (virtualBg.type !== 'none' && segmentationReady) {
        fullscreenVideo.classList.add('has-vbg');
        fsVbgCanvas.style.display = 'block';
        fsVbgCanvas.style.filter = filter.css;
        fullscreenVideo.onloadedmetadata = () => {
          startVirtualBackground(fullscreenVideo, fsVbgCanvas);
        };
        if (fullscreenVideo.readyState >= 2) {
          startVirtualBackground(fullscreenVideo, fsVbgCanvas);
        }
      } else {
        fullscreenVideo.classList.remove('has-vbg');
        fsVbgCanvas.style.display = 'none';
      }

      updatePhotoCount();
      updateMiniFramePreview();
      fullscreenCaptureBtn.disabled = false;
    }

    function exitFullscreenCamera() {
      isFullscreen = false;
      fullscreenCamera.classList.remove('active');
      fullscreenCountdown.classList.remove('active');
      stopVirtualBackground();
      updatePreview();
    }

    function updatePhotoCount() {
      const current = photos.length + 1;
      const total = getEffectiveSlots();
      photoCountEl.textContent = `${current}/${total}`;
    }

    function updateMiniFramePreview() {
      const footer = document.getElementById('footerInput').value || '';
      const header = document.getElementById('headerInput').value || '';
      const dateVal = document.getElementById('dateInput').value || '';
      const songName = document.getElementById('spotifySong').value || 'SNOOZE';
      const artistName = document.getElementById('spotifyArtist').value || 'SZA';
      const newsHeadline = document.getElementById('newspaperHeadline').value || 'HEADLINE HERE';
      const newsDate = document.getElementById('newspaperDate').value || 'DATE';
      const newsLocation = document.getElementById('newspaperLocation').value || 'LOCATION';
      const newsEdition = document.getElementById('newspaperEdition').value || 'SPECIAL EDITION';
      const effectiveSlots = getEffectiveSlots();
      let slotsHtml = '';

      for (let i = 0; i < effectiveSlots; i++) {
        if (photos[i]) {
          slotsHtml += `<div class="photo-slot"><img src="${photos[i]}" style="filter:${filter.css}"></div>`;
        } else if (i === photos.length) {
          slotsHtml += `<div class="photo-slot" style="background:var(--accent);opacity:0.6"><span class="placeholder" style="opacity:1;color:#fff;font-size:10px">LIVE</span></div>`;
        } else {
          slotsHtml += `<div class="photo-slot"><span class="placeholder">${i + 1}</span></div>`;
        }
      }

      let gridHtml = `<div class="photo-grid">${slotsHtml}</div>`;
      let footerHtml = footer ? `<div class="frame-footer">${footer}</div>` : '';

      // Theme-specific elements for mini preview
      let extraHtml = '';
      const dateFormatted = formatDate(dateVal);
      const dateNumeric = formatDateNumeric(dateVal);

      if (theme.id === 'magic') {
        extraHtml = `<svg class="mickey mickey-tl" viewBox="0 0 128 128"><circle cx="64" cy="72" r="40"/><circle cx="32" cy="32" r="24"/><circle cx="96" cy="32" r="24"/></svg><svg class="mickey mickey-br" viewBox="0 0 128 128"><circle cx="64" cy="72" r="40"/><circle cx="32" cy="32" r="24"/><circle cx="96" cy="32" r="24"/></svg>`;
      } else if (theme.id === 'xmark') {
        extraHtml = `<span class="xmark-icon">âœ•</span>`;
        if (dateVal) extraHtml += `<span class="date-stamp">${dateNumeric}</span>`;
      } else if (theme.id === 'classicbw') {
        if (header) extraHtml += `<span class="text-overlay">${header}</span>`;
        if (dateVal) extraHtml += `<span class="date-stamp">${dateFormatted}</span>`;
      } else if (theme.id === 'yellow' || theme.id === 'red' || theme.id === 'blue') {
        if (dateVal) extraHtml += `<span class="date-stamp">${dateFormatted}</span>`;
      } else if (theme.id === 'spotify') {
        extraHtml = `
          <div class="music-player">
            <div class="music-header">
              <div class="album-art">ðŸŽµ</div>
              <div class="song-info">
                <div class="song-title">${songName}</div>
                <div class="song-artist">${artistName}</div>
              </div>
              <span class="song-heart">â™¡</span>
            </div>
            <div class="progress-bar"><div class="progress-fill"></div></div>
            <div class="progress-times"><span>1:24</span><span>-2:18</span></div>
            <div class="player-controls">
              <span class="ctrl-btn">â®</span>
              <div class="play-btn">â–¶</div>
              <span class="ctrl-btn">â­</span>
            </div>
          </div>
        `;
        footerHtml = '';
      }

      let frameHtml = '';
      const customBg = (customFrameColor && customColorThemes.includes(theme.id)) ? `background:${customFrameColor};` : '';
      if (theme.id === 'film') {
        frameHtml = `<div class="photo-frame theme-${theme.id} layout-${layout.id}" style="${customBg}"><div class="film-wrap">${gridHtml}</div>${footerHtml}</div>`;
      } else if (theme.id === 'newspaper') {
        frameHtml = `<div class="photo-frame theme-${theme.id} layout-${layout.id}" style="${customBg}">
          <div class="newspaper-header">
            <div class="newspaper-title">The Birthday Times</div>
            <div class="newspaper-meta"><span>${newsDate}</span><span>${newsLocation}</span></div>
            <div class="newspaper-headline">${newsHeadline}</div>
          </div>
          ${gridHtml}
          <div class="frame-footer">${newsEdition}</div>
        </div>`;
      } else {
        frameHtml = `<div class="photo-frame theme-${theme.id} layout-${layout.id}" style="${customBg}">${gridHtml}${footerHtml}${extraHtml}</div>`;
      }

      miniFramePreview.innerHTML = frameHtml;
    }

    function fullscreenCapture() {
      if (photos.length >= getEffectiveSlots()) return;
      fullscreenCaptureBtn.disabled = true;

      // Start countdown
      let n = 3;
      fullscreenCountdown.textContent = n;
      fullscreenCountdown.classList.add('active');

      const t = setInterval(() => {
        n--;
        if (n > 0) {
          fullscreenCountdown.textContent = n;
        } else {
          clearInterval(t);
          fullscreenCountdown.classList.remove('active');
          doCapture();
        }
      }, 1000);
    }

    function doCapture() {
      const fsVbgCanvas = document.getElementById('fullscreenVbgCanvas');
      const useVbg = virtualBg.type !== 'none' && fsVbgCanvas && fsVbgCanvas.width > 0;

      canvas.width = fullscreenVideo.videoWidth;
      canvas.height = fullscreenVideo.videoHeight;

      if (useVbg) {
        // Capture from virtual background canvas (already has background applied)
        ctx.save();
        ctx.filter = filter.css;
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(fsVbgCanvas, 0, 0, canvas.width, canvas.height);
        ctx.restore();
      } else {
        // Capture from video directly
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.filter = filter.css;
        ctx.drawImage(fullscreenVideo, 0, 0);
        ctx.setTransform(1, 0, 0, 1, 0, 0);
      }

      // Flash effect
      fullscreenFlash.classList.add('active');
      setTimeout(() => fullscreenFlash.classList.remove('active'), 200);

      if (navigator.vibrate) navigator.vibrate(50);

      photos.push(canvas.toDataURL('image/jpeg', 0.9));
      updatePhotoCount();
      updateMiniFramePreview();

      // Check if all photos taken
      if (photos.length >= getEffectiveSlots()) {
        // All done - exit fullscreen and stop camera
        setTimeout(() => {
          exitFullscreenCamera();
          stopCamera();
        }, 500);
      } else {
        // Re-enable capture button for next photo
        setTimeout(() => {
          fullscreenCaptureBtn.disabled = false;
        }, 300);
      }
    }

    // Legacy capture function (not used in fullscreen mode)
    function capture() {
      const v = document.getElementById('liveVideo');
      if (!v) return;
      canvas.width = v.videoWidth; canvas.height = v.videoHeight;
      ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
      ctx.filter = filter.css; ctx.drawImage(v, 0, 0);
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      const fl = document.getElementById('flash');
      if (fl) { fl.classList.add('active'); setTimeout(() => fl.classList.remove('active'), 150); }
      if (navigator.vibrate) navigator.vibrate(50);
      photos.push(canvas.toDataURL('image/jpeg', 0.9));
      updatePreview();
      if (photos.length >= getEffectiveSlots()) setTimeout(stopCamera, 500);
    }

    async function downloadFrame() {
      if (cameraOn) stopCamera();
      await new Promise(r => setTimeout(r, 100));
      try {
        const out = await html2canvas(document.getElementById('photoFrame'), { scale: 3, useCORS: true, backgroundColor: null });
        const a = document.createElement('a');
        a.download = `coquette-${theme.id}-${layout.id}-${Date.now()}.png`;
        a.href = out.toDataURL('image/png');
        a.click();
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
      } catch (e) { alert('Download failed'); }
    }

    init();
  </script>
</body>
</html>
